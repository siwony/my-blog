<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CORS해결기 근데 이제 Spring Security를 곁들인</title><link rel="stylesheet" href="/assets/css/prism/prism-material-theme.css"><link rel="stylesheet" href="/assets/css/prism/prism-toolbar.min.css"><link rel="stylesheet" href="/assets/css/prism/prism-line-numbers.min.css"><link rel="stylesheet" href="/assets/css/style.css"><script type="module" src="https://unpkg.com/ninja-keys?module"></script></head><body><div class="container"><header><h1><a href="/">My Tech Blog</a></h1><nav><ul><li><a href="/">Home</a></li></ul></nav></header><main><article class="post"><header class="post-header"><h1 class="post-title">CORS해결기 근데 이제 Spring Security를 곁들인</h1><post-metadata layout="inline" categories='["back-end"]' tags='["spring","TIL","spring-security"]' date="July 04, 2022" reading-time="2" compact="false"></post-metadata><div class="post-author"><span class="author-label">작성자:</span> <span class="author-name">jeongcool</span></div></header><div class="post-content"><h1 id="cors해결기-근데-이제-spring-security를-곁들인">CORS해결기 근데 이제 Spring Security를 곁들인</h1><p>Web Application 처음 프론트엔드 백앤드로 나눠서 협업을 진행하다보면 한번쯤 CORS에러를 겪는다.</p><p>CORS는 브라우저의 보안 정책중 하나지만, 서버에서 요청을 응답할 떄 CORS관련 Header를 작성하여 보내줘야 한다.<br>MDN문서에 CORS관련해서 자바 코드로 된 예제가 있으니 참고하길 바란다.(https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Access-Control-Allow-Origin)</p><h3 id="springmvc의-cors설정">SpringMVC의 CORS설정</h3><p>일반적으로 Spring Boot를 통해 WAS를 만들게 된다면, Spring MVC를 사용하게 된다. <code>WebMvcConfigurer</code>를 상속받은 후 <code>addCorsMappings</code> 매서드를 통해 CORS를 설정할 수 있다.</p><p>대부분 아래 예제 코드에 나와있는 방식으로 CORS문제를 해결할 것이다.</p><blockquote><p>이렇게 코드를 통해 설정하면 Spring MVC가 내부적으로 Filter를 통해 CORS관련 Header를 만들어준다. ```kotlin @Configuration class WebMvcCorsConfig: WebMvcConfigurer{</p></blockquote><pre><code>override fun addCorsMappings(registry: CorsRegistry) {
    registry
        .addMapping("/**")
        .allowedOrigins("https://www.hirecruit.site")
        .allowedMethods(*allowedHttpMethod())
        .allowCredentials(true)
        .maxAge(3000);
}

private fun allowedHttpMethod(): Array&lt;String&gt; =
    arrayOf(
        HttpMethod.GET.name,
        HttpMethod.POST.name,
        HttpMethod.PATCH.name,
        HttpMethod.PUT.name,
        HttpMethod.DELETE.name,
        HttpMethod.HEAD.name,
        HttpMethod.OPTIONS.name,
    ) } ```
</code></pre><h3 id="하지만-spring-security를-사용하게-된다면">하지만 Spring Security를 사용하게 된다면?</h3><p>Spring Security는 Spring기반의 애플리케이션의 보안(인증/인가/취약점 방어 등)을 담당하는 Spring하위의 프레임워크이다. 기본적으로 Spring Security도 필터 기반으로 동작하고 있다. (아까 CORS설정도 filter를 통한다는 사실도 꼭 기억하자)</p><p>Spring Security를 사용해서 사용자의 역할(Role)별로 endpoint의 접근을 관리할 수 있다. 아래는 hirecruit프로젝트에 사용되었던 설정 클래스의 일부이다.</p><pre><code class="language-kotlin">@Configuration
class SecurityConfig: WebSecurityConfigurerAdapter(){
    ...
    override fun configure(http: HttpSecurity) {
        ...
        http.authorizeRequests{
                it.antMatchers(
                    "/worker/me/**"
                ).hasAnyRole(Role.WORKER.name, Role.MENTOR.name)
        }
        ...
    }
}
</code></pre><p><code>/worker/me/**</code>표현식에 해당하는 endpoint에 대해 <code>WORKER</code>와 <code>MENTOR</code>의 역할을 가지고 있는 사용자만 접근할 수 있다.<br>그렇지 않은 사용자가 해당 endpoint에 접근하면 401혹은 개발자가 작성한 handler에 따라 동작이 달라지겠지만 일반적인 API서버를 만든다면 401를 리턴하게 될 것이다.</p><h3 id="401-error와-함께-발생한-cors">401 error와 함께 발생한 CORS</h3><p>preflight요청은 서버에 어떤 method, header, content type을 지원하는지 사전에 확인하는 요청이다.<br>preflight요청은 주로 브라우저의 스크립트로 보내는 Fetch, Axios요청에 사용된다.</p><p>preflight 요청은 OPTIONS method를 사용하여 요청한다.<br>OPTIONS method는 요청시 header, cookie, body를 포함하지 않아 client에서 사용자 인증정보를 보낼 수 없다.</p><p>그러므로 클라이언트에서는 preflight요청이 실패하였으므로 cors에러가 반환되었고, preflight요청 후 본 요청에 대해 실패하였으므로 <code>error.response.status</code>객체를 통해서 status code를 불러올 수 없었고 이로인해 예외처리를 하지 못하는 상황이 되었다.</p><p>그래서 모든 OPTIONS 메서드의 요청을 모두 접근할 수 있게 변경하였다.</p><pre><code class="language-kotlin">@Configuration
class SecurityConfig: WebSecurityConfigurerAdapter(){
    ...
    override fun configure(http: HttpSecurity) {
        ...
        http.authorizeRequests{
                it.antMatchers(HttpMethod.OPTIONS, "/**").permitAll() // CORS를 위해 OPTION method는 모든 요청에 대해 권한없이 접근할 수 있다.
                it.antMatchers(
                    "/worker/me/**"
                ).hasAnyRole(Role.WORKER.name, Role.MENTOR.name)
        }
        ...
    }
}
</code></pre><p>하지만 여기서 끝난 것이 아니다. security에 cors설정을 적용시키려면 configure매서드에서 <code>HttpSecurity.cors()</code>를 통해 cors설정을 적용시킨다는 것을 spring security에 알려줘야 한다.</p><pre><code class="language-kotlin">@Configuration
class SecurityConfig: WebSecurityConfigurerAdapter(){
    ...
    override fun configure(http: HttpSecurity) {
        ...
        http.cors() // 여기
        http.authorizeRequests{
                it.antMatchers(HttpMethod.OPTIONS, "/**").permitAll() // CORS를 위해 OPTION method는 모든 요청에 대해 권한없이 접근할 수 있다.
                it.antMatchers(
                    "/worker/me/**"
                ).hasAnyRole(Role.WORKER.name, Role.MENTOR.name)
        }
        ...
    }
}
</code></pre><p><code>http.cors()</code>를 통해 <code>WebMvcConfigurer</code>를 통해 설정한 cors설정을 적용하였다. Security에서 <code>cors</code>설정을 하는 방법이 있지만 귀찮으므로 여기에 적진 않겠다.</p></div><footer class="post-footer"><div class="post-navigation"><div class="nav-previous"><span class="nav-label">이전 글</span> <a href="/programming/2022/06/28/weakhashmap/" class="nav-link">WeakHashMap</a></div><div class="nav-next"><span class="nav-label">다음 글</span> <a href="/back-end/2022/07/12/spring-transaction-propagation-%EC%8A%A4%ED%94%84%EB%A7%81-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%A0%84%ED%8C%8C%EC%86%8D%EC%84%B1/" class="nav-link">Spring Transaction Propagation - 스프링 트랜잭션 전파속성</a></div></div></footer></article></main></div><script src="/assets/js/prism/prism.min.js"></script><script src="/assets/js/prism/prism-autoloader.min.js"></script><script src="/assets/js/prism/prism-toolbar.min.js"></script><script src="/assets/js/prism/prism-copy-to-clipboard.min.js"></script><script src="/assets/js/prism/prism-show-language.min.js"></script><script src="/assets/js/prism/prism-line-numbers.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){Prism.plugins&&Prism.plugins.autoloader&&(Prism.plugins.autoloader.languages_path="/assets/js/prism/components/",console.log("Prism autoloader configured with local path:",Prism.plugins.autoloader.languages_path)),document.querySelectorAll('pre[class*="language-"]').forEach(function(s){s.classList.add("line-numbers")}),Prism.highlightAll()})</script><script src="/assets/js/command-palette.js"></script><script src="/assets/js/category-sidebar.js"></script><script src="/assets/js/post-metadata.js"></script></body></html>