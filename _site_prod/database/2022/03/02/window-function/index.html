<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Window Function</title><link rel="stylesheet" href="/assets/css/prism/prism-material-theme.css"><link rel="stylesheet" href="/assets/css/prism/prism-toolbar.min.css"><link rel="stylesheet" href="/assets/css/prism/prism-line-numbers.min.css"><link rel="stylesheet" href="/assets/css/style.css"><script type="module" src="https://unpkg.com/ninja-keys?module"></script></head><body><div class="container"><header><h1><a href="/">My Tech Blog</a></h1><nav><ul><li><a href="/">Home</a></li></ul></nav></header><main><article class="post"><header class="post-header"><h1 class="post-title">Window Function</h1><post-metadata layout="inline" categories='["database"]' tags='["sql","TIL"]' date="March 02, 2022" reading-time="5" compact="false"></post-metadata><div class="post-author"><span class="author-label">작성자:</span> <span class="author-name">jeongcool</span></div></header><div class="post-content"><h1 id="window-function">Window Function</h1><p>: 행과 행 간의 관계를 정의하기 위해 제공되는 함수다.</p><ul><li>순위, 합계, 평균, 행 위치 등을 조작할 수 있다.</li><li>GROUP BY 구문과 병행하여 사용할 수 없다.</li><li>SUM, MAX, MIN과 같은 집계 윈도우 함수를 사용할 떄 <strong>윈도우 절</strong>과 함께 사용하면 집계 대상이 되는 <strong>레코드 범위를 지정</strong>할 수 있다.</li></ul><h3 id="함수-종류">함수 종류</h3><h4 id="1-순위-함수">1. 순위 함수</h4><ul><li>RANK</li><li>DENSE_RANK</li><li>ROW_NUMBER</li></ul><h4 id="2-윈도우-집계-함수">2. 윈도우 집계 함수</h4><ul><li>SUM, MAX, MIN, AVG, COUNT</li></ul><h4 id="3-행-순서-함수">3. 행 순서 함수</h4><ul><li>FIRST_VALUE</li><li>LAST_VALUE,</li><li>LAG</li><li>LEAD</li></ul><h4 id="4-비율-함수">4. 비율 함수</h4><ul><li>RATIO_TO_REPORT</li><li>PERCENT_RANK</li><li>CUME_DIST</li><li>NTILE</li></ul><h2 id="1-구조">1. 구조</h2><h3 id="1-1-윈도우-함수-구조">1-1. 윈도우 함수 구조</h3><pre><code class="language-sql">SELECT WINDOW_FUNCTION(ARGUMENTS)
    OVER ( &lt;PARTITION BY 컬럼&gt; &lt;ORDER BY 절&gt; &lt;WINDOWING 절&gt; )
FROM 테이블명;

-- ex

SELECT JOB, SUM(SAL) OVER (PARTITION BY JOB
                ORDER BY SAL DESC
                ROWS UNBOUNDED PRECEDING
                ) as SUM_SAL
FROM EMP;
</code></pre><blockquote><p>&lt;&gt;는 선택가능</p></blockquote><table><thead><tr><th>구조</th><th>설명</th></tr></thead><tbody><tr><td>ARGUMENTS(인수)</td><td>윈도우 함수에 따라서 N개의 인수를 설정한다.</td></tr><tr><td>PARTITION BY</td><td>전체 집합을 기준에 의해 소그룹으로 나눈다.</td></tr><tr><td>ORDER BY</td><td>어떤 항목에 대해서 정렬한다.</td></tr><tr><td>WINDOWING</td><td>- 행 기준 범위를 정한다.<br>- ROWS는 물리적 결과의 행 수이고 RANGE는 논리적인 값에 의한 범위이다.</td></tr></tbody></table><h3 id="1-2-windowing">1-2. WINDOWING</h3><p>| 구조 | 설명 | |———–|———————————–| |ROWS |부분집합인 윈도우 크기를 <strong>물리적 단위로 행의 집합을 지정</strong>한다. 즉 <strong>행의 수를 선택</strong>한다.| |RANGE |논리적 주소에 의해 행 집합을 지정한다. 즉 <strong>값의 범위</strong>를 지정한다.| |BETWEEN ~ AND| 윈도우의 시작과 끝 위치를 지정한다. | |UNBOUNDED PRECEDING|<strong>윈도우 시작 위치가 첫 번째 행</strong>임을 의미한다.| |UNBOUNDED FOLLOWING|<strong>윈도우 마지막 위치가 마지막 행</strong>임을 의미한다.| |CURRENT ROW |윈도우 <strong>시작 위치가 현재 행</strong>임을 의미한다.</p><h4 id="windowing-예시">WINDOWING 예시</h4><p>전체 합계</p><pre><code class="language-sql">SELECT EMPNO, ENAME, SQL
SUM(SAL) ORVER(ORDER BY SAL
    ROWS BETWEEN UNBOUNDED PRECEDING
    AND UNBOUNDED FOLLOWING) AS TOTSAL
)
FROM EMP;
</code></pre><p>TOTSAL의 처음부터 마지막까지의 합계(<code>SUM(SAL)</code>)를 계산한 것이다.</p><blockquote><p>AS는 생략 가능하다.</p></blockquote><p>누적합계</p><pre><code class="language-sql">SELECT EMPNO, ENAME, SAL
SUM(SQL) OVER(ORDER BY SQL
    ROWS BETWEEN UNBOUNDED PRECEDING
    AND CURRENT ROW) AS TOTSAL
FROM EMP;
</code></pre><ul><li>처음부터 CURRENT ROW까지의 합계를 계산한다.<blockquote><p>누적합계</p></blockquote></li><li>1번째 행의 값이 1, 2번째 행의 값이 2, 3번째 행의 값이 3이면 <code>1 + 2 + 3 = 4</code>과 같이 계산된다.</li></ul><h3 id="1-3-순위-함수---rank-function">1-3. 순위 함수 - RANK FUNCTION</h3><p>: 윈도우 함수는 특정 항목과 파티션에 대해서 순위를 계산할 수 있는 함수를 제공한다. | 순위 함수 | 설명 | |———–|———————————–| |RANK | - 특정항목 및 파티션에 대해 순위를 계산한다.<br>- <strong>동일한 순위는 동일한 값</strong>이 부여된다| |DENSE_RANK | - <strong>동일한 순위를 하나의 건수</strong>로 계산하다. | |ROW_NUMBER | - <strong>동일한 순위에 대해서 고유의 순위를 부여</strong>한다.|</p><h4 id="rank-function-에시">RANK FUNCTION 에시</h4><h4 id="1-내림차순-및-파티션">1. 내림차순 및 파티션</h4><pre><code class="language-sql">SELECT ENAME, SAL,
    RANK() OVER (ORDER BY SAL DESC) AS ALL_RANK, # SAL로 등수를 계산하고, 내림차순으로 조회한다.
    RANK() OVER (PARTITION BY JOB ORDER BY SAL DESC) AS JOB_RANK, # JOB으로 파티션을 만들고, JOB별로 SAL 순위를 조회하게 한다.
FROM EMP;
</code></pre><ul><li>동일한 순위에는 같은 순위가 부여된다.<blockquote><p>1, 2, 2, 4, 5, 6, 6, 8</p></blockquote></li></ul><h4 id="2-dense-rank">2. DENSE RANK</h4><pre><code class="language-sql">SELECT ENAME, SAL,
    RANK() OVER (ORDER BY SAL DESC) AS ALL_RANK,
    DENSE_RANK() OVER(ORDER BY SAL DESC) AS DENSE_RANK
FROM EMP;
</code></pre><ul><li><code>DENSE_RANK</code>는 동일한 순위를 하나의 건수로 인식해서 조회한다.<blockquote><p>1, 2, 2, 3, 4, 5, 5, 5, 6</p></blockquote></li></ul><h4 id="3-row-number">3, ROW NUMBER</h4><pre><code class="language-sql">SELECT ENAME, SAL,
    RANK() OVER (ORDER BY SAL DESC) ALL_RANK,
    ROW_NUMBER() OVER (ORDER BY SAL DESC) ROW_NUM
FROM EMP;
</code></pre><ul><li><code>ROW_NUMBER</code>함수는 동일한 순위에 대해서 고유의 순위를 부여한다.<blockquote><p>DENSE_RANK기준 1, 2, 2, 4, 5가 ROW_NUMBER로 1, 2, 3, 4, 5로 조회된다.</p></blockquote></li></ul><h3 id="1-4-집계-함수---aggregate-function">1-4. 집계 함수 - AGGREGATE FUNCTION</h3><p>| 집계 함수 | 설명 | |———–|———————————–| |SUM |파티션 별로 합계를 계산한다. | |AVG |파티션 별로 평균을 계산한다. | |COUNT |파티션 별로 행 수를 계산한다. | |MAX와 MIN |파티션 별로 최댓값과 최솟값을 계산한다. |</p><h4 id="집계-함수-예시">집계 함수 예시</h4><h4 id="1-sum">1. SUM</h4><pre><code class="language-sql">SELECT ENAME, SAL,
SUM(SAL) OVER (PARTITION BY MGR) SUM_MGR
FROM EMP;
</code></pre><ul><li>같은 <code>관리자 - MGR</code>에 파티션을 만들고 <code>합계 - SUM</code>를 계산한다.</li></ul><h3 id="1-5-행-순서-관련-함수">1-5. 행 순서 관련 함수</h3><ul><li>행 순서 관련 함수는 <strong>상위 행 값을 하위에 출력</strong>하거나 <strong>그 반대로 출력</strong>할 수 있다.</li><li><strong>특정 위치의 행을 출력</strong>할 수 있다.</li></ul><table><thead><tr><th>집계 함수</th><th>설명</th></tr></thead><tbody><tr><td>FIRST_VALUE</td><td>- 파티션에서 <strong>가장 처음에 나오는 값</strong>을 구한다.</td></tr><tr><td>LAST_VALUE</td><td>- 파티션에서 <strong>가장 나중에 나오는 값</strong>을 구한다.</td></tr><tr><td>LAG</td><td>- <strong>이전 행</strong>을 가지고 온다.</td></tr><tr><td>LEAD</td><td>- 윈도우에서 특정 위치의 행을 가지고 온다.<br>- 기본값은 1이다.</td></tr></tbody></table><h4 id="행-순서-관련-함수-예시">행 순서 관련 함수 예시</h4><h4 id="1-first_value">1. FIRST_VALUE</h4><pre><code class="language-sql">SELECT DEPTNO, ENAME, SAL,
FIRST VALUE(ENAME) OVER (
    PARTITION BY DEPTNO
    ORDER BY SAL DESC ROS UNBOUNDED PRECEDING) AS DEPT_A
FROM EMP;
</code></pre><ul><li>부서로 파티션을 나누고, 부서별로 급여가 가장 많은 직원의 이름을 4번째 칼럼에 배치한다.</li></ul><h4 id="2-last_value">2. LAST_VALUE</h4><pre><code class="language-sql">SELECT DEPTNO, ENAME, SAL,
    LAST_VALUE(ENAME) OVER (PARTITION BY DEPTNO
    ORDER BY SAL DESC ROWS BETWEEN CURRENT ROW AND
    DEPT) AS A 
FROM EMP;
</code></pre><ul><li><code>LAST_VALUE</code>는 마지막행을 가지고 오고,</li><li><code>BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING</code>은 부서 내에서 급여가 가장 적은 사람을 가지고 온다.</li></ul><h4 id="3-lag">3. LAG</h4><pre><code class="language-sql">SELECT DEPTNO, ENAME, SAL, LAG(SAL, 2)
    OVER (ORDER BY SAL DESC) AS PRE_SAL
FROM EMP; 
</code></pre><ul><li>해당 행에서 2번째 이전의 값을 가지고 온다.</li></ul><h3 id="1-6-비율-관련-함수">1-6. 비율 관련 함수</h3><ul><li>누적 백분율, 순서별 백분율, 파티션을 N분으로 분할한 결과 등을 조회할 수 있다.</li></ul><table><thead><tr><th>집계 함수</th><th>설명</th></tr></thead><tbody><tr><td>CUME_DIST</td><td>- 파티션 전체 건수에서 현재 행보다 작거나 같은 건수에 대한 누적 백분율을 조회한다.<br>- 누적 분포상에 위치를 0~1사이의 값을 가진다.</td></tr><tr><td>PERCENT_RANK</td><td>행의 순서별 백분율을 조회한다.</td></tr><tr><td>NTILE</td><td>파티션 별로 전체 건수를 ARGUMENT 값으로 N등분한 결과를 조회한다.</td></tr><tr><td>RATIO_TO_REPORT</td><td>파티션 내에 전체 SUM(칼럼)에 대한 행 별 칼럼 값의 백분율을 소수점까지 조회한다.</td></tr></tbody></table></div><footer class="post-footer"><div class="post-navigation"><div class="nav-previous"><span class="nav-label">이전 글</span> <a href="/database/2022/03/02/case-%ED%91%9C%ED%98%84/" class="nav-link">CASE 표현</a></div><div class="nav-next"><span class="nav-label">다음 글</span> <a href="/database/2022/03/15/mongodb/" class="nav-link">MongoDB</a></div></div></footer></article></main></div><script src="/assets/js/prism/prism.min.js"></script><script src="/assets/js/prism/prism-autoloader.min.js"></script><script src="/assets/js/prism/prism-toolbar.min.js"></script><script src="/assets/js/prism/prism-copy-to-clipboard.min.js"></script><script src="/assets/js/prism/prism-show-language.min.js"></script><script src="/assets/js/prism/prism-line-numbers.min.js"></script><script>document.addEventListener("DOMContentLoaded",function(){Prism.plugins&&Prism.plugins.autoloader&&(Prism.plugins.autoloader.languages_path="/assets/js/prism/components/",console.log("Prism autoloader configured with local path:",Prism.plugins.autoloader.languages_path)),document.querySelectorAll('pre[class*="language-"]').forEach(function(s){s.classList.add("line-numbers")}),Prism.highlightAll()})</script><script src="/assets/js/command-palette.js"></script><script src="/assets/js/category-sidebar.js"></script><script src="/assets/js/post-metadata.js"></script></body></html>