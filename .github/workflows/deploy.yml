name: Deploy Jekyll to S3 + CloudFront

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write   # OIDC에 필수
  contents: write   # 카테고리 자동 커밋에 필요

concurrency:
  group: deploy-jekyll
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # git diff를 위해 이전 커밋 필요

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Sync categories
        run: |
          chmod +x scripts/sync_categories.sh
          ./scripts/sync_categories.sh --verbose

      - name: Commit category changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add category/
          git diff --staged --quiet || git commit -m "[bot] Sync categories"
          git push || echo "Nothing to push"

      - name: Build (bundle + Jekyll + Gulp minification)
        env:
          JEKYLL_ENV: production
          NODE_ENV: production
        run: npm run build:prod

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Deploy to S3
        run: |
          aws s3 sync _site s3://${{ vars.S3_BUCKET }} --delete --size-only

      - name: Fix rss.xml content-type
        run: |
          aws s3 cp _site/rss.xml s3://${{ vars.S3_BUCKET }}/rss.xml \
            --content-type "application/rss+xml; charset=utf-8" \
            --metadata-directive REPLACE

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.CF_DISTRIBUTION_ID }} \
            --paths "/*"
